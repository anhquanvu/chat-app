<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat Application</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2/lib/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .auth-btn:hover {
            opacity: 0.9;
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            color: #e53e3e;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* Chat Interface */
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            background: #e9ecef;
        }

        .sidebar-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #495057;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .sidebar-tab.active {
            background: #f8f9fa;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .sidebar-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sidebar-panel {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-panel.active {
            display: flex;
        }

        .sidebar-header {
            padding: 15px;
            background: #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            font-size: 16px;
            color: #495057;
        }

        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-btn:hover {
            background: #5a67d8;
        }

        .sidebar-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .list-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: 2px solid transparent;
        }

        .list-item:hover {
            background: #e9ecef;
        }

        .list-item.active {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .item-name {
            font-weight: 600;
            flex: 1;
        }

        .item-time {
            font-size: 12px;
            opacity: 0.7;
        }

        .item-preview {
            font-size: 14px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-badge {
            background: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 10px;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-left: 10px;
        }

        /* Chat Content */
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-content-header {
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn:hover {
            background: #5a6268;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fff;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.chat {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .message.own {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.system {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            text-align: center;
            font-style: italic;
            margin: 10px auto;
            max-width: 50%;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.8;
        }

        .message-sender {
            font-weight: bold;
        }

        .message-time {
            font-size: 11px;
        }

        .message-content {
            margin-bottom: 5px;
        }

        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 11px;
            opacity: 0.7;
        }

        .message-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-icon {
            font-size: 12px;
        }

        .status-sending { color: #6c757d; }
        .status-sent { color: #28a745; }
        .status-delivered { color: #17a2b8; }
        .status-read { color: #007bff; }
        .status-failed { color: #dc3545; }

        .message-reactions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .reaction-item {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .reaction-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .reaction-item.own-reaction {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.4);
        }

        .reaction-emoji {
            font-size: 14px;
        }

        .reaction-count {
            font-size: 11px;
            font-weight: 500;
        }

        .add-reaction-btn {
            background: rgba(255,255,255,0.1);
            border: 1px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-reaction-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: #666;
            font-size: 14px;
            background: #f8f9fa;
            border-radius: 20px;
            margin: 10px 0;
            display: none;
            animation: pulse 1.5s infinite;
        }

        .typing-indicator.show {
            display: block;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots::after {
            content: '';
            animation: typing-dots 1.5s infinite;
        }

        @keyframes typing-dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .reaction-picker {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .reaction-picker.show {
            display: block;
        }

        .reaction-option {
            font-size: 20px;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .reaction-option:hover {
            background: #f8f9fa;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            text-align: center;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .message-input-container {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .file-input {
            display: none;
        }

        .file-btn, .send-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .file-btn {
            background: #6c757d;
            color: white;
        }

        .file-btn:hover {
            background: #5a6268;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .send-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        .search-box {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .search-box:focus {
            border-color: #667eea;
            outline: none;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-item.selected {
            background: #e7f3ff;
            border: 2px solid #667eea;
        }

        .user-item-avatar {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-item-username {
            font-size: 14px;
            color: #666;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: fixed;
                top: 0;
                left: -100%;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s;
            }

            .sidebar.show {
                left: 0;
            }

            .container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
<!-- Authentication Modal -->
<div id="authModal" class="auth-modal">
    <div class="auth-container">
        <div class="auth-header">
            <h2>🚀 Secure Chat</h2>
            <p>Đăng nhập để bắt đầu trò chuyện</p>
        </div>

        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchTab('login')">Đăng nhập</div>
            <div class="auth-tab" onclick="switchTab('register')">Đăng ký</div>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="auth-form active">
            <div class="form-group">
                <label>Tên đăng nhập hoặc Email</label>
                <input type="text" id="loginUsername" required>
            </div>
            <div class="form-group">
                <label>Mật khẩu</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="auth-btn">Đăng nhập</button>
            <div id="loginError" class="error-message"></div>
        </form>

        <!-- Register Form -->
        <form id="registerForm" class="auth-form">
            <div class="form-group">
                <label>Tên đăng nhập</label>
                <input type="text" id="regUsername" required minlength="3">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="regEmail" required>
            </div>
            <div class="form-group">
                <label>Họ tên</label>
                <input type="text" id="regFullName">
            </div>
            <div class="form-group">
                <label>Số điện thoại</label>
                <input type="tel" id="regPhone">
            </div>
            <div class="form-group">
                <label>Mật khẩu</label>
                <input type="password" id="regPassword" required minlength="6">
            </div>
            <button type="submit" class="auth-btn">Đăng ký</button>
            <div id="registerError" class="error-message"></div>
        </form>
    </div>
</div>

<!-- Main Chat Interface -->
<div id="chatContainer" class="container hidden">
    <div class="chat-header">
        <h1>💬 Secure Chat</h1>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar"></div>
            <div>
                <div id="currentUsername"></div>
                <div style="font-size: 12px; opacity: 0.8;" id="userRole"></div>
            </div>
            <button class="logout-btn" onclick="logout()">Đăng xuất</button>
        </div>
    </div>

    <div class="chat-main">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchSidebarTab('conversations')">Cuộc trò chuyện</div>
                <div class="sidebar-tab" onclick="switchSidebarTab('rooms')">Phòng chat</div>
                <div class="sidebar-tab" onclick="switchSidebarTab('contacts')">Danh bạ</div>
            </div>

            <div class="sidebar-content">
                <!-- Conversations Panel -->
                <div id="conversationsPanel" class="sidebar-panel active">
                    <div class="sidebar-header">
                        <h3>Cuộc trò chuyện</h3>
                        <button class="add-btn" onclick="showAddConversationModal()">+ Bắt đầu chat</button>
                    </div>
                    <div class="sidebar-list" id="conversationsList">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Chưa có cuộc trò chuyện nào
                        </div>
                    </div>
                </div>

                <!-- Rooms Panel -->
                <div id="roomsPanel" class="sidebar-panel">
                    <div class="sidebar-header">
                        <h3>Phòng chat</h3>
                        <button class="add-btn" onclick="showCreateRoomModal()">+ Tạo phòng</button>
                    </div>
                    <div class="sidebar-list" id="roomsList">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Đang tải...
                        </div>
                    </div>
                </div>

                <!-- Contacts Panel -->
                <div id="contactsPanel" class="sidebar-panel">
                    <div class="sidebar-header">
                        <h3>Danh bạ</h3>
                        <button class="add-btn" onclick="showAddContactModal()">+ Thêm bạn</button>
                    </div>
                    <div class="sidebar-list" id="contactsList">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            Đang tải...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Content -->
        <div class="chat-content">
            <div id="emptyChatState" class="empty-state">
                <h3>👋 Chào mừng đến với Secure Chat!</h3>
                <p>Chọn một cuộc trò chuyện, phòng chat hoặc bắt đầu chat mới để bắt đầu.</p>
            </div>

            <div id="activeChatContent" class="hidden">
                <div class="chat-content-header">
                    <div class="chat-title" id="chatTitle">Chọn cuộc trò chuyện</div>
                    <div class="chat-actions">
                        <button class="action-btn" onclick="searchInChat()">🔍 Tìm kiếm</button>
                        <button class="action-btn" onclick="showChatInfo()">ℹ️ Thông tin</button>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>

                <div class="message-input-container">
                    <div class="input-group">
                        <input type="file" id="fileInput" class="file-input" accept="*/*">
                        <button class="file-btn" onclick="selectFile()" title="Đính kèm file">📎</button>
                        <input
                                type="text"
                                id="messageInput"
                                class="message-input"
                                placeholder="Nhập tin nhắn..."
                                maxlength="1000"
                        >
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Gửi tin nhắn">✈️</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Conversation Modal -->
<div id="addConversationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Bắt đầu cuộc trò chuyện</h3>
            <button class="close-btn" onclick="closeModal('addConversationModal')">&times;</button>
        </div>
        <input type="text" class="search-box" placeholder="Tìm kiếm người dùng..." id="userSearchInput">
        <div class="user-list" id="userSearchResults">
            <div style="text-align: center; padding: 20px; color: #666;">
                Nhập tên để tìm kiếm người dùng
            </div>
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button class="auth-btn" onclick="startConversation()" id="startConversationBtn" disabled>Bắt đầu chat</button>
        </div>
    </div>
</div>

<!-- Create Room Modal -->
<div id="createRoomModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Tạo phòng chat</h3>
            <button class="close-btn" onclick="closeModal('createRoomModal')">&times;</button>
        </div>
        <div class="form-group">
            <label>Tên phòng</label>
            <input type="text" id="roomName" placeholder="Nhập tên phòng..." maxlength="100">
        </div>
        <div class="form-group">
            <label>Mô tả</label>
            <textarea id="roomDescription" placeholder="Mô tả phòng..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; resize: vertical;"></textarea>
        </div>
        <div class="form-group">
            <label>Loại phòng</label>
            <select id="roomType" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                <option value="GROUP">Phòng nhóm</option>
                <option value="PRIVATE">Phòng riêng tư</option>
            </select>
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button class="auth-btn" onclick="createRoom()">Tạo phòng</button>
        </div>
    </div>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Thêm bạn bè</h3>
            <button class="close-btn" onclick="closeModal('addContactModal')">&times;</button>
        </div>
        <input type="text" class="search-box" placeholder="Tìm kiếm người dùng..." id="contactSearchInput">
        <div class="user-list" id="contactSearchResults">
            <div style="text-align: center; padding: 20px; color: #666;">
                Nhập tên để tìm kiếm người dùng
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let stompClient = null;
    let currentUser = null;
    let authToken = null;
    let refreshToken = null;
    let connected = false;
    let currentChatType = null; // 'room' or 'conversation'
    let currentChatId = null;
    let selectedUserId = null;
    let typingTimer = null;
    let isCurrentlyTyping = false;
    let typingUsers = new Set();
    let currentMessageForReaction = null;

    // Authentication functions
    function switchTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

        if (tab === 'login') {
            document.querySelector('.auth-tab').classList.add('active');
            document.getElementById('loginForm').classList.add('active');
        } else {
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('registerForm').classList.add('active');
        }

        document.getElementById('loginError').textContent = '';
        document.getElementById('registerError').textContent = '';
    }

    // Sidebar navigation
    function switchSidebarTab(tab) {
        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tab + 'Panel').classList.add('active');

        // Load data based on selected tab
        if (tab === 'conversations') {
            loadConversations();
        } else if (tab === 'rooms') {
            loadRooms();
        } else if (tab === 'contacts') {
            loadContacts();
        }
    }

    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');

        if (!username || !password) {
            errorDiv.textContent = 'Vui lòng nhập đầy đủ thông tin';
            return;
        }

        try {
            const response = await fetch('/api/auth/signin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            });

            if (response.ok) {
                const data = await response.json();
                handleAuthSuccess(data);
            } else {
                const error = await response.text();
                errorDiv.textContent = error || 'Đăng nhập thất bại';
            }
        } catch (error) {
            console.error('Login error:', error);
            errorDiv.textContent = 'Lỗi kết nối đến server';
        }
    });

    // Register form handler
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('regUsername').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const fullName = document.getElementById('regFullName').value.trim();
        const phoneNumber = document.getElementById('regPhone').value.trim();
        const password = document.getElementById('regPassword').value;
        const errorDiv = document.getElementById('registerError');

        if (!username || !email || !password) {
            errorDiv.textContent = 'Vui lòng nhập đầy đủ thông tin bắt buộc';
            return;
        }

        if (password.length < 6) {
            errorDiv.textContent = 'Mật khẩu phải có ít nhất 6 ký tự';
            return;
        }

        try {
            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    email: email,
                    fullName: fullName,
                    phoneNumber: phoneNumber,
                    password: password
                })
            });

            if (response.ok) {
                const data = await response.json();
                handleAuthSuccess(data);
            } else {
                const error = await response.text();
                errorDiv.textContent = error || 'Đăng ký thất bại';
            }
        } catch (error) {
            console.error('Register error:', error);
            errorDiv.textContent = 'Lỗi kết nối đến server';
        }
    });

    function handleAuthSuccess(data) {
        authToken = data.accessToken;
        refreshToken = data.refreshToken;
        currentUser = {
            id: data.userId,
            username: data.username,
            fullName: data.fullName,
            email: data.email
        };

        localStorage.setItem('authToken', authToken);
        localStorage.setItem('refreshToken', refreshToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));

        document.getElementById('currentUsername').textContent = currentUser.fullName || currentUser.username;
        document.getElementById('userAvatar').textContent = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
        document.getElementById('userRole').textContent = 'Thành viên';

        document.getElementById('authModal').classList.add('hidden');
        document.getElementById('chatContainer').classList.remove('hidden');

        connectWebSocket();
        loadInitialData();
    }

    function logout() {
        if (authToken) {
            fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            }).catch(error => console.error('Logout error:', error));
        }

        if (stompClient) {
            stompClient.disconnect();
            stompClient = null;
        }

        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('currentUser');

        authToken = null;
        refreshToken = null;
        currentUser = null;
        currentChatType = null;
        currentChatId = null;

        document.getElementById('authModal').classList.remove('hidden');
        document.getElementById('chatContainer').classList.add('hidden');

        document.getElementById('loginForm').reset();
        document.getElementById('registerForm').reset();
        document.getElementById('loginError').textContent = '';
        document.getElementById('registerError').textContent = '';
    }

    // WebSocket connection
    function connectWebSocket() {
        if (!authToken || !currentUser) {
            console.error('No auth token or user data');
            return;
        }

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        const connectHeaders = {
            'Authorization': 'Bearer ' + authToken
        };

        stompClient.connect(connectHeaders, function (frame) {
            console.log('Connected to WebSocket:', frame);
            connected = true;

            // Subscribe to user status updates
            stompClient.subscribe('/topic/user-status', function (message) {
                const userStatus = JSON.parse(message.body);
                updateUserStatus(userStatus);
            });

        }, function(error) {
            console.error('WebSocket connection error:', error);
            connected = false;

            if (error.includes('401') || error.includes('403')) {
                refreshAuthToken();
            }
        });
    }

    async function refreshAuthToken() {
        if (!refreshToken) {
            logout();
            return;
        }

        try {
            const response = await fetch('/api/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: refreshToken
            });

            if (response.ok) {
                const data = await response.json();
                authToken = data.accessToken;
                refreshToken = data.refreshToken;

                localStorage.setItem('authToken', authToken);
                localStorage.setItem('refreshToken', refreshToken);

                connectWebSocket();
            } else {
                logout();
            }
        } catch (error) {
            console.error('Token refresh error:', error);
            logout();
        }
    }

    // Load initial data
    async function loadInitialData() {
        await Promise.all([
            loadConversations(),
            loadRooms(),
            loadContacts()
        ]);
    }

    // Load conversations
    async function loadConversations() {
        try {
            const response = await fetch('/api/conversations?page=0&size=50', {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayConversations(data.conversations || []);
            }
        } catch (error) {
            console.error('Error loading conversations:', error);
            document.getElementById('conversationsList').innerHTML =
                '<div style="text-align: center; padding: 20px; color: #dc3545;">Lỗi tải dữ liệu</div>';
        }
    }

    function displayConversations(conversations) {
        const container = document.getElementById('conversationsList');

        if (conversations.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Chưa có cuộc trò chuyện nào</div>';
            return;
        }

        container.innerHTML = conversations.map(conv => `
            <div class="list-item" onclick="openConversation(${conv.id}, '${conv.participant?.fullName || conv.participant?.username}')">
                <div class="item-header">
                    <div class="item-name">${conv.participant?.fullName || conv.participant?.username}</div>
                    <div class="item-time">${formatTime(conv.lastMessageAt)}</div>
                    ${conv.unreadCount > 0 ? `<div class="item-badge">${conv.unreadCount}</div>` : ''}
                </div>
                <div class="item-preview">${conv.lastMessage?.content || 'Chưa có tin nhắn'}</div>
            </div>
        `).join('');
    }

    // Load rooms
    async function loadRooms() {
        try {
            const response = await fetch('/api/rooms?page=0&size=50', {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayRooms(data.content || []);
            }
        } catch (error) {
            console.error('Error loading rooms:', error);
            document.getElementById('roomsList').innerHTML =
                '<div style="text-align: center; padding: 20px; color: #dc3545;">Lỗi tải dữ liệu</div>';
        }
    }

    function displayRooms(rooms) {
        const container = document.getElementById('roomsList');

        if (rooms.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Chưa tham gia phòng nào</div>';
            return;
        }

        container.innerHTML = rooms.map(room => `
            <div class="list-item" onclick="openRoom(${room.id}, '${room.name}')">
                <div class="item-header">
                    <div class="item-name">${room.name}</div>
                    <div class="item-time">${formatTime(room.lastActivityAt)}</div>
                    ${room.unreadCount > 0 ? `<div class="item-badge">${room.unreadCount}</div>` : ''}
                </div>
                <div class="item-preview">
                    👥 ${room.memberCount} thành viên • ${room.lastMessage?.content || 'Chưa có tin nhắn'}
                </div>
            </div>
        `).join('');
    }

    // Load contacts
    async function loadContacts() {
        try {
            const response = await fetch('/api/users/contacts?status=ACCEPTED&page=0&size=50', {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayContacts(data.content || []);
            }
        } catch (error) {
            console.error('Error loading contacts:', error);
            document.getElementById('contactsList').innerHTML =
                '<div style="text-align: center; padding: 20px; color: #dc3545;">Lỗi tải dữ liệu</div>';
        }
    }

    function displayContacts(contacts) {
        const container = document.getElementById('contactsList');

        if (contacts.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Chưa có bạn bè nào</div>';
            return;
        }

        container.innerHTML = contacts.map(contact => `
            <div class="list-item" onclick="startDirectChat(${contact.contact.id}, '${contact.contact.fullName || contact.contact.username}')">
                <div class="item-header">
                    <div class="item-name">${contact.contact.fullName || contact.contact.username}</div>
                    ${contact.contact.isOnline ? '<div class="online-indicator"></div>' : ''}
                </div>
                <div class="item-preview">@${contact.contact.username}</div>
            </div>
        `).join('');
    }

    // Open chat functions
    function openConversation(conversationId, title) {
        currentChatType = 'conversation';
        currentChatId = conversationId;

        // Update active state
        document.querySelectorAll('#conversationsList .list-item').forEach(item => item.classList.remove('active'));
        event.target.closest('.list-item').classList.add('active');

        // Show chat content
        document.getElementById('emptyChatState').classList.add('hidden');
        document.getElementById('activeChatContent').classList.remove('hidden');
        document.getElementById('chatTitle').textContent = title;

        // Subscribe to conversation
        if (stompClient && connected) {
            stompClient.subscribe(`/topic/conversation/${conversationId}`, function (message) {
                const response = JSON.parse(message.body);
                console.log('Conversation message received:', response);

                if (response.type === 'MESSAGE' && response.action === 'SEND') {
                    showMessage(response.data);
                } else if (response.type === 'TYPING') {
                    handleTypingNotification(response.data);
                } else if (response.type === 'REACTION') {
                    handleReactionUpdate(response.data);
                } else {
                    // Handle direct message format (backward compatibility)
                    if (response.data && response.data.type === 'CHAT') {
                        showMessage(response.data);
                    } else if (response.data && response.data.isTyping !== undefined) {
                        handleTypingNotification(response.data);
                    }
                }
            });
        }

        loadConversationMessages(conversationId);
    }

    function openRoom(roomId, title) {
        currentChatType = 'room';
        currentChatId = roomId;

        // Update active state
        document.querySelectorAll('#roomsList .list-item').forEach(item => item.classList.remove('active'));
        event.target.closest('.list-item').classList.add('active');

        // Show chat content
        document.getElementById('emptyChatState').classList.add('hidden');
        document.getElementById('activeChatContent').classList.remove('hidden');
        document.getElementById('chatTitle').textContent = title;

        // Subscribe to room
        if (stompClient && connected) {
            stompClient.subscribe(`/topic/room/${roomId}`, function (message) {
                const response = JSON.parse(message.body);
                console.log('Room message received:', response);

                if (response.type === 'MESSAGE' && response.action === 'SEND') {
                    showMessage(response.data);
                } else if (response.type === 'TYPING') {
                    handleTypingNotification(response.data);
                } else if (response.type === 'REACTION') {
                    handleReactionUpdate(response.data);
                } else {
                    // Handle direct message format (backward compatibility)
                    if (response.data && response.data.type === 'CHAT') {
                        showMessage(response.data);
                    } else if (response.data && response.data.isTyping !== undefined) {
                        handleTypingNotification(response.data);
                    }
                }
            });
        }

        loadRoomMessages(roomId);
    }

    async function startDirectChat(userId, userName) {
        try {
            const response = await fetch(`/api/conversations/direct/${userId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (response.ok) {
                const conversation = await response.json();

                // Switch to conversations tab
                switchSidebarTab('conversations');

                // Open the conversation
                openConversation(conversation.id, userName);

                // Reload conversations list
                loadConversations();
            }
        } catch (error) {
            console.error('Error starting direct chat:', error);
            alert('Không thể bắt đầu cuộc trò chuyện');
        }
    }

    // Load messages functions
    async function loadConversationMessages(conversationId) {
        try {
            const response = await fetch(`/api/conversations/${conversationId}/messages?page=0&size=50`, {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayMessages(data.content || []);
            }
        } catch (error) {
            console.error('Error loading conversation messages:', error);
        }
    }

    async function loadRoomMessages(roomId) {
        try {
            const response = await fetch(`/api/rooms/${roomId}/messages?page=0&size=50`, {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayMessages(data.content || []);
            }
        } catch (error) {
            console.error('Error loading room messages:', error);
        }
    }

    function displayMessages(messages) {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';

        if (messages.length === 0) {
            container.innerHTML = '<div class="message system"><div class="message-content">Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện! 🎉</div></div>';
            return;
        }

        // Reverse to show oldest first
        messages.reverse().forEach(message => showMessage(message));
        container.scrollTop = container.scrollHeight;
    }

    function showMessage(message) {
        const container = document.getElementById('messagesContainer');

        // Check if message already exists (avoid duplicates)
        const existingMessage = container.querySelector(`[data-message-id="${message.id}"]`);
        if (existingMessage) {
            // Update existing message if needed
            return;
        }

        const messageElement = document.createElement('div');
        const isOwnMessage = message.senderId === currentUser.id;
        let messageClass = 'message ';

        if (message.type === 'JOIN' || message.type === 'LEAVE') {
            messageClass += 'system';
            messageElement.innerHTML = `
                <div class="message-content">${message.content || `${message.senderName} đã ${message.type === 'JOIN' ? 'tham gia' : 'rời khỏi'} phòng chat`}</div>
            `;
        } else if (message.type === 'CHAT') {
            messageClass += isOwnMessage ? 'own' : 'chat';
            const timestamp = new Date(message.timestamp).toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const messageId = message.id;
            const statusIcon = getStatusIcon(message.status);
            const reactions = message.reactions || [];

            messageElement.innerHTML = `
                ${!isOwnMessage ? `<div class="message-header">
                    <span class="message-sender">${message.senderName}</span>
                    <span class="message-time">${timestamp}</span>
                </div>` : ''}
                <div class="message-content">${message.content}</div>
                ${reactions.length > 0 ? `<div class="message-reactions">
                    ${reactions.map(reaction => `
                        <div class="reaction-item ${reaction.currentUserReacted ? 'own-reaction' : ''}"
                             onclick="toggleReaction('${messageId}', '${reaction.type}')">
                            <span class="reaction-emoji">${reaction.emoji}</span>
                            <span class="reaction-count">${reaction.count}</span>
                        </div>
                    `).join('')}
                    <div class="add-reaction-btn" onclick="showReactionPicker('${messageId}', event)">➕</div>
                </div>` : `<div class="message-reactions">
                    <div class="add-reaction-btn" onclick="showReactionPicker('${messageId}', event)">➕</div>
                </div>`}
                <div class="message-footer">
                    ${isOwnMessage ? `<div class="message-status">
                        <span class="status-icon ${message.status ? message.status.toLowerCase() : 'sent'}">${statusIcon}</span>
                        <span class="status-text">${getStatusText(message.status)}</span>
                    </div>` : ''}
                    ${isOwnMessage ? `<div class="message-time">${timestamp}</div>` : ''}
                </div>
            `;

            // Add double-click to edit for own messages
            if (isOwnMessage) {
                messageElement.addEventListener('dblclick', () => editMessage(messageId, message.content));
            }
        }

        messageElement.className = messageClass;
        messageElement.dataset.messageId = message.id;
        container.appendChild(messageElement);
        container.scrollTop = container.scrollHeight;

        // Mark message as read if not own message
        if (!isOwnMessage && currentChatType && currentChatId) {
            setTimeout(() => markMessageAsRead(message.id), 1000); // Delay to simulate reading
        }
    }

    function getStatusIcon(status) {
        const icons = {
            'SENDING': '🕐',
            'SENT': '✓',
            'DELIVERED': '✓✓',
            'READ': '✓✓',
            'FAILED': '❌'
        };
        return icons[status] || '✓';
    }

    function getStatusText(status) {
        const texts = {
            'SENDING': 'Đang gửi',
            'SENT': 'Đã gửi',
            'DELIVERED': 'Đã nhận',
            'READ': 'Đã xem',
            'FAILED': 'Thất bại'
        };
        return texts[status] || 'Đã gửi';
    }

    // Send message function
    function sendMessage() {
        const messageContent = document.getElementById('messageInput').value.trim();
        if (!messageContent || !stompClient || !connected || !currentChatType || !currentChatId) return;

        const chatMessage = {
            content: messageContent,
            type: 'CHAT'
        };

        if (currentChatType === 'room') {
            stompClient.send(`/app/chat/room/${currentChatId}`, {}, JSON.stringify(chatMessage));
        } else if (currentChatType === 'conversation') {
            stompClient.send(`/app/chat/conversation/${currentChatId}`, {}, JSON.stringify(chatMessage));
        }

        document.getElementById('messageInput').value = '';

        // Stop typing
        sendStopTyping();
    }

    // Typing functions
    function sendTyping() {
        if (!stompClient || !connected || !currentChatType || !currentChatId) return;

        const typingMessage = {
            typing: true
        };

        if (currentChatType === 'room') {
            stompClient.send(`/app/chat/typing/room/${currentChatId}`, {}, JSON.stringify(typingMessage));
        } else if (currentChatType === 'conversation') {
            stompClient.send(`/app/chat/typing/conversation/${currentChatId}`, {}, JSON.stringify(typingMessage));
        }
    }

    function sendStopTyping() {
        if (!stompClient || !connected || !currentChatType || !currentChatId) return;

        const stopTypingMessage = {
            typing: false
        };

        if (currentChatType === 'room') {
            stompClient.send(`/app/chat/typing/room/${currentChatId}`, {}, JSON.stringify(stopTypingMessage));
        } else if (currentChatType === 'conversation') {
            stompClient.send(`/app/chat/typing/conversation/${currentChatId}`, {}, JSON.stringify(stopTypingMessage));
        }

        isCurrentlyTyping = false;
    }

    function handleTypingNotification(data) {
        console.log('Typing notification:', data);

        // Skip own typing notifications
        if (data.userId === currentUser.id) return;

        // Handle both formats: direct data or wrapped in response
        const typingData = data.data || data;
        const username = typingData.username || typingData.senderUsername;
        const isTyping = typingData.isTyping !== undefined ? typingData.isTyping : typingData.typing;

        if (isTyping) {
            typingUsers.add(username);
        } else {
            typingUsers.delete(username);
        }

        updateTypingIndicator();
    }

    function updateTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        const textElement = document.getElementById('typingText');

        if (typingUsers.size > 0) {
            const userList = Array.from(typingUsers);
            let typingText = '';

            if (userList.length === 1) {
                typingText = `${userList[0]} đang nhập`;
            } else if (userList.length === 2) {
                typingText = `${userList[0]} và ${userList[1]} đang nhập`;
            } else {
                typingText = `${userList.length} người đang nhập`;
            }

            textElement.textContent = typingText;
            indicator.classList.add('show');
        } else {
            indicator.classList.remove('show');
        }
    }

    // Message reactions
    function showReactionPicker(messageId, event) {
        event.stopPropagation();

        const picker = document.getElementById('reactionPicker');
        currentMessageForReaction = messageId;

        // Position picker near the click
        picker.style.left = event.pageX + 'px';
        picker.style.top = (event.pageY - 50) + 'px';
        picker.classList.add('show');
    }

    function addReaction(reactionType) {
        if (!currentMessageForReaction) return;

        const request = {
            messageId: currentMessageForReaction,
            type: reactionType
        };

        fetch(`/api/messages/${currentMessageForReaction}/reactions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + authToken
            },
            body: JSON.stringify(request)
        }).then(response => {
            if (response.ok) {
                // Reaction will be updated via WebSocket
                hideReactionPicker();
            }
        }).catch(error => {
            console.error('Error adding reaction:', error);
        });
    }

    function toggleReaction(messageId, reactionType) {
        // Remove reaction if user already reacted with this type
        fetch(`/api/messages/${messageId}/reactions`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + authToken
            }
        }).then(response => {
            if (response.ok) {
                // Reaction will be updated via WebSocket
            }
        }).catch(error => {
            console.error('Error removing reaction:', error);
        });
    }

    function hideReactionPicker() {
        document.getElementById('reactionPicker').classList.remove('show');
        currentMessageForReaction = null;
    }

    function handleReactionUpdate(reactions) {
        // Update reactions in the message
        // This would typically update the UI based on the reaction data
        console.log('Reaction update:', reactions);
    }

    // Mark message as read
    async function markMessageAsRead(messageId) {
        try {
            await fetch('/api/messages/read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({
                    messageId: messageId,
                    roomId: currentChatType === 'room' ? currentChatId : null,
                    conversationId: currentChatType === 'conversation' ? currentChatId : null
                })
            });
        } catch (error) {
            console.error('Error marking message as read:', error);
        }
    }

    // Edit message
    function editMessage(messageId, currentContent) {
        const newContent = prompt('Chỉnh sửa tin nhắn:', currentContent);
        if (newContent && newContent !== currentContent) {
            fetch(`/api/messages/${messageId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify(newContent)
            }).then(response => {
                if (response.ok) {
                    // Message will be updated via WebSocket
                }
            }).catch(error => {
                console.error('Error editing message:', error);
            });
        }
    }

    // Modal functions
    function showAddConversationModal() {
        document.getElementById('addConversationModal').classList.add('show');
        selectedUserId = null;
        document.getElementById('startConversationBtn').disabled = true;
    }

    function showCreateRoomModal() {
        document.getElementById('createRoomModal').classList.add('show');
    }

    function showAddContactModal() {
        document.getElementById('addContactModal').classList.add('show');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    // Search users
    let searchTimeout;
    document.getElementById('userSearchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const keyword = this.value.trim();

        if (keyword.length < 2) {
            document.getElementById('userSearchResults').innerHTML =
                '<div style="text-align: center; padding: 20px; color: #666;">Nhập ít nhất 2 ký tự để tìm kiếm</div>';
            return;
        }

        searchTimeout = setTimeout(() => searchUsers(keyword, 'userSearchResults'), 500);
    });

    document.getElementById('contactSearchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const keyword = this.value.trim();

        if (keyword.length < 2) {
            document.getElementById('contactSearchResults').innerHTML =
                '<div style="text-align: center; padding: 20px; color: #666;">Nhập ít nhất 2 ký tự để tìm kiếm</div>';
            return;
        }

        searchTimeout = setTimeout(() => searchUsers(keyword, 'contactSearchResults'), 500);
    });

    async function searchUsers(keyword, resultContainerId) {
        try {
            const response = await fetch(`/api/users/search?keyword=${encodeURIComponent(keyword)}&page=0&size=20`, {
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayUserSearchResults(data.users || [], resultContainerId);
            }
        } catch (error) {
            console.error('Error searching users:', error);
            document.getElementById(resultContainerId).innerHTML =
                '<div style="text-align: center; padding: 20px; color: #dc3545;">Lỗi tìm kiếm</div>';
        }
    }

    function displayUserSearchResults(users, containerId) {
        const container = document.getElementById(containerId);

        if (users.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Không tìm thấy người dùng nào</div>';
            return;
        }

        container.innerHTML = users.map(user => `
            <div class="user-item" onclick="selectUser(${user.id}, '${user.fullName || user.username}', '${containerId}')">
                <div class="user-item-avatar">${(user.fullName || user.username).charAt(0).toUpperCase()}</div>
                <div class="user-item-info">
                    <div class="user-item-name">${user.fullName || user.username}</div>
                    <div class="user-item-username">@${user.username}</div>
                </div>
                ${user.isOnline ? '<div class="status-badge status-online">Online</div>' : '<div class="status-badge status-offline">Offline</div>'}
            </div>
        `).join('');
    }

    function selectUser(userId, userName, containerId) {
        // Remove previous selections
        document.querySelectorAll(`#${containerId} .user-item`).forEach(item => item.classList.remove('selected'));

        // Add selection to clicked item
        event.target.closest('.user-item').classList.add('selected');

        if (containerId === 'userSearchResults') {
            selectedUserId = userId;
            document.getElementById('startConversationBtn').disabled = false;
        } else if (containerId === 'contactSearchResults') {
            // Send friend request
            sendFriendRequest(userId);
        }
    }

    async function startConversation() {
        if (!selectedUserId) return;

        try {
            const response = await fetch(`/api/conversations/direct/${selectedUserId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                }
            });

            if (response.ok) {
                const conversation = await response.json();
                closeModal('addConversationModal');

                // Switch to conversations tab and open the conversation
                switchSidebarTab('conversations');
                setTimeout(() => {
                    loadConversations();
                    openConversation(conversation.id, conversation.participant?.fullName || conversation.participant?.username);
                }, 500);
            }
        } catch (error) {
            console.error('Error starting conversation:', error);
            alert('Không thể bắt đầu cuộc trò chuyện');
        }
    }

    async function createRoom() {
        const name = document.getElementById('roomName').value.trim();
        const description = document.getElementById('roomDescription').value.trim();
        const type = document.getElementById('roomType').value;

        if (!name) {
            alert('Vui lòng nhập tên phòng');
            return;
        }

        try {
            const response = await fetch('/api/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    type: type
                })
            });

            if (response.ok) {
                const room = await response.json();
                closeModal('createRoomModal');

                // Clear form
                document.getElementById('roomName').value = '';
                document.getElementById('roomDescription').value = '';

                // Switch to rooms tab and reload
                switchSidebarTab('rooms');
                setTimeout(() => {
                    loadRooms();
                    openRoom(room.id, room.name);
                }, 500);
            } else {
                const error = await response.text();
                alert('Lỗi tạo phòng: ' + error);
            }
        } catch (error) {
            console.error('Error creating room:', error);
            alert('Không thể tạo phòng');
        }
    }

    async function sendFriendRequest(userId) {
        try {
            const response = await fetch('/api/users/contacts/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({
                    contactId: userId
                })
            });

            if (response.ok) {
                alert('Đã gửi lời mời kết bạn!');
                closeModal('addContactModal');
            } else {
                const error = await response.text();
                alert('Lỗi: ' + error);
            }
        } catch (error) {
            console.error('Error sending friend request:', error);
            alert('Không thể gửi lời mời kết bạn');
        }
    }

    // Utility functions
    function formatTime(dateString) {
        if (!dateString) return '';

        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        if (diff < 24 * 60 * 60 * 1000) { // Less than 24 hours
            return date.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        } else {
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit'
            });
        }
    }

    function updateUserStatus(userStatus) {
        // Update online status in contact list
        const contactItems = document.querySelectorAll('#contactsList .list-item');
        contactItems.forEach(item => {
            // Update based on user status
        });
    }

    // File upload
    function selectFile() {
        document.getElementById('fileInput').click();
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadFile(file);
        }
    });

    async function uploadFile(file) {
        if (!file || !authToken) return;

        if (file.size > 50 * 1024 * 1024) {
            alert('File quá lớn! Kích thước tối đa là 50MB.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/files/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + authToken
                },
                body: formData
            });

            if (response.ok) {
                const fileMessage = await response.json();

                // Send message with file attachment
                const chatMessage = {
                    content: `Đã gửi một file: ${fileMessage.originalFileName}`,
                    type: 'FILE',
                    fileUploadId: fileMessage.id
                };

                if (currentChatType === 'room') {
                    stompClient.send(`/app/chat/room/${currentChatId}`, {}, JSON.stringify(chatMessage));
                } else if (currentChatType === 'conversation') {
                    stompClient.send(`/app/chat/conversation/${currentChatId}`, {}, JSON.stringify(chatMessage));
                }

                document.getElementById('fileInput').value = '';
            } else {
                const error = await response.text();
                alert('Upload thất bại: ' + error);
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Upload thất bại: ' + error.message);
        }
    }

    // Event listeners
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Typing detection
    document.getElementById('messageInput').addEventListener('input', function() {
        if (!connected) return;

        if (!isCurrentlyTyping) {
            sendTyping();
            isCurrentlyTyping = true;
        }

        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            sendStopTyping();
        }, 1500);
    });

    // Hide reaction picker when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.reaction-picker') && !e.target.closest('.add-reaction-btn')) {
            hideReactionPicker();
        }
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    });

    // Initialize app
    function initializeApp() {
        const storedToken = localStorage.getItem('authToken');
        const storedRefreshToken = localStorage.getItem('refreshToken');
        const storedUser = localStorage.getItem('currentUser');

        if (storedToken && storedRefreshToken && storedUser) {
            try {
                authToken = storedToken;
                refreshToken = storedRefreshToken;
                currentUser = JSON.parse(storedUser);

                document.getElementById('currentUsername').textContent = currentUser.fullName || currentUser.username;
                document.getElementById('userAvatar').textContent = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
                document.getElementById('userRole').textContent = 'Thành viên';

                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('chatContainer').classList.remove('hidden');

                connectWebSocket();
                loadInitialData();
            } catch (error) {
                console.error('Error parsing stored user data:', error);
                logout();
            }
        }
    }

    // Page load event
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });

    // Periodic token refresh (every 20 minutes)
    setInterval(() => {
        if (refreshToken && authToken) {
            refreshAuthToken();
        }
    }, 20 * 60 * 1000);

    console.log('🚀 Complete Chat Application initialized');
</script>
</body>
</html>